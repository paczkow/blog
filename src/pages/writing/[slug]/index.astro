---
import Prose from "@/components/Prose.astro";
import Layout from "@/layouts/Base.astro";
import { Icon } from "astro-icon/components";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const essayCollection = await getCollection("essays");

  const essays = await Promise.all(
    essayCollection.map(async (essay) => {
      const { remarkPluginFrontmatter } = await render(essay);

      return {
        params: { slug: essay.id },
        props: {
          post: {
            type: "essay" as const,
            readTime: remarkPluginFrontmatter.minutesRead,
            ...essay,
          },
        },
      };
    }),
  );

  return essays;
}

const props = Astro.props;
const { post } = props;
const { Content, headings } = await render(post);
---

<Layout title={post.data.title}>
  <div
    class="mx-auto grid grid-cols-1 lg:grid-cols-[192px_65ch_1fr] px-8 lg:px-8 gap-x-12 xl:gap-x-16"
  >
    <!-- Row 1: Back link and Title -->
    <div class="hidden lg:block">
      <a
        href="/writing"
        class="text-sand-11 underline hover:text-sand-12 flex items-center gap-1"
      >
        <Icon name="arrow-up-left" class="w-4 h-4" />
        All Writing
      </a>
    </div>
    <div class="mb-16">
      <h1 class="text-sand-12 font-medium md:text-lg">{post.data.title}</h1>
      <time
        class="text-sand-11 text-sm"
        datetime={post.data.date.toISOString()}
      >
        {
          post.data.date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }
      </time>
    </div>
    <div class="hidden lg:block"></div>

    <!-- Row 2: TOC and Content -->
    <aside class="hidden lg:block">
      {
        post.data.toc && (
          <nav id="toc" class="sticky top-36">
            <ul class="list-none p-0 m-0">
              {headings
                .filter((h) => h.depth === 2)
                .map((heading) => (
                  <li
                    data-scroll-section={heading.slug}
                    class="cursor-pointer text-sand-8 my-2 hover:text-sand-12 text-xs"
                  >
                    {heading.text.replace("#", "")}
                  </li>
                ))}
            </ul>
          </nav>
        )
      }
    </aside>
    <article>
      <Prose>
        <Content />
      </Prose>
      <a
        href="/writing"
        class="text-sand-11 underline hover:text-sand-12 flex items-center gap-1 mt-12 lg:hidden"
      >
        <Icon name="arrow-up-left" class="w-4 h-4" />
        All Writing
      </a>
    </article>
    <div class="hidden lg:block"></div>
  </div>
</Layout>

<style>
  #toc ul {
    list-style: none;
    padding-left: 0;
    margin-left: 0;

    & li {
      padding-left: 0;
      margin-left: 0;

      &:hover {
        color: var(--color-sand-12);
      }
    }
  }
</style>

<script>
  const { hash } = window.location;
  let observerEnabled = true;

  document.addEventListener("DOMContentLoaded", () => {
    const links = Array.from(document.querySelectorAll("#toc li"));
    if (links.length === 0) return;

    const activeLink =
      links.find(
        (link) =>
          link.getAttribute("data-scroll-section") === hash.replace("#", ""),
      ) ?? links[0];

    activeLink?.classList.add("text-sand-12");

    links.forEach((link) => {
      link.addEventListener("click", () => {
        const id = link.getAttribute("data-scroll-section");
        const section = document.getElementById(id ?? "");

        links.forEach((l) => l.classList.remove("text-sand-12"));
        link.classList.add("text-sand-12");

        if (section) {
          observerEnabled = false;
          section?.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
          setTimeout(() => {
            observerEnabled = true;
          }, 1000);
        }
      });
    });
  });

  const headers = document.querySelectorAll("h2");
  const links = Array.from(document.querySelectorAll("#toc li"));

  const seen = new WeakSet();

  // Function to check if we're at the bottom of the page
  const isAtBottom = () => {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    return scrollTop + windowHeight >= documentHeight - 50;
  };

  const observer = new IntersectionObserver(
    (entries) => {
      if (!observerEnabled) return;

      // Check if we're at the bottom of the page first
      if (isAtBottom()) {
        links.forEach((link) => link.classList.remove("text-sand-12"));
        if (links.length > 0) {
          links[links.length - 1].classList.add("text-sand-12");
        }
        return;
      }

      entries.forEach((entry) => {
        if (!seen.has(entry.target)) {
          seen.add(entry.target);
          return;
        }

        const current = links.findIndex((link) => {
          const id = link.getAttribute("data-scroll-section");
          return id === entry.target.id;
        });

        if (entry.isIntersecting) {
          links.forEach((link, index) => {
            if (index === current) {
              link.classList.add("text-sand-12");
            } else {
              link.classList.remove("text-sand-12");
            }
          });
        } else if (
          entry.intersectionRatio === 0 &&
          entry.boundingClientRect.bottom >= 0 &&
          current > 0
        ) {
          links[current].classList.remove("text-sand-12");
          links[current - 1].classList.add("text-sand-12");
        }
      });
    },
    {
      root: null,
      rootMargin: "0px 0px -50% 0px",
    },
  );

  headers.forEach((header) => observer.observe(header));
</script>
